{"version":3,"file":"managed.js","sourceRoot":"","sources":["../../src/integrations/managed.ts"],"names":[],"mappings":"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","sourcesContent":["import * as Updates from './Updates';\nimport { Platform } from 'react-native';\nimport Constants from 'expo-constants';\nimport * as Device from 'expo-device';\nimport {\n  setExtras,\n  setTags,\n  getCurrentHub,\n  setTag,\n  addGlobalEventProcessor,\n} from '@sentry/react-native';\nimport { SeverityLevel } from '@sentry/types';\n\nconst DEFAULT_TAGS = [\n  {\n    tagName: 'expoReleaseChannel',\n    manifestName: 'releaseChannel',\n  },\n  {\n    tagName: 'appVersion',\n    manifestName: 'version',\n  },\n  {\n    tagName: 'appPublishedTime',\n    manifestName: 'publishedTime',\n  },\n  {\n    tagName: 'expoSdkVersion',\n    manifestName: 'sdkVersion',\n  },\n];\n\nexport class ExpoManagedIntegration {\n  static id = 'ExpoManagedIntegration';\n  name = ExpoManagedIntegration.id;\n\n  setupOnce() {\n    const manifest = Updates.manifest as any;\n\n    setExtras({\n      manifest,\n      deviceYearClass: Device.deviceYearClass,\n      linkingUri: Constants.linkingUri,\n    });\n\n    setTags({\n      deviceId: Constants.sessionId,\n      appOwnership: Constants.appOwnership || 'N/A',\n    });\n\n    if (Constants.appOwnership === 'expo' && Constants.expoVersion) {\n      setTag('expoAppVersion', Constants.expoVersion);\n    }\n\n    if (typeof manifest === 'object') {\n      DEFAULT_TAGS.forEach((tag) => {\n        if (manifest.hasOwnProperty(tag.manifestName)) {\n          setTag(tag.tagName, manifest[tag.manifestName]);\n        }\n      });\n    }\n\n    if (Updates.channel) {\n      setTag('expoChannel', Updates.channel);\n    }\n\n    const defaultHandler = ErrorUtils.getGlobalHandler();\n\n    ErrorUtils.setGlobalHandler((error, isFatal) => {\n      // On Android, the Expo bundle filepath cannot be handled by TraceKit,\n      // so we normalize it to use the same filepath that we use on Expo iOS.\n      if (Platform.OS === 'android') {\n        error.stack = error.stack.replace(\n          /\\/.*\\/\\d+\\.\\d+.\\d+\\/cached\\-bundle\\-experience\\-/g,\n          'https://classic-assets.eascdn.net:443/'\n        );\n      }\n\n      getCurrentHub().withScope((scope) => {\n        if (isFatal) {\n          scope.setLevel(\"fatal\" as SeverityLevel);\n        }\n        getCurrentHub().captureException(error, {\n          originalException: error,\n        });\n      });\n\n      const client = getCurrentHub().getClient();\n      if (client && !__DEV__) {\n        // @ts-ignore PR to add this to types: https://github.com/getsentry/sentry-javascript/pull/2669\n        client.flush(client.getOptions().shutdownTimeout || 2000).then(() => {\n          defaultHandler(error, isFatal);\n        });\n      } else {\n        // If there is no client, something is fishy but we call the default handler anyway. Even if in dev\n        defaultHandler(error, isFatal);\n      }\n    });\n\n    addGlobalEventProcessor(function (event, _hint) {\n      const that = getCurrentHub().getIntegration(ExpoManagedIntegration);\n\n      if (that) {\n        event.contexts = {\n          ...(event.contexts || {}),\n          device: {\n            simulator: !Device.isDevice,\n            model: Device.modelName || undefined,\n          },\n          os: {\n            name: Device.osName || undefined,\n            version: Device.osVersion || undefined,\n          },\n        };\n      }\n\n      return event;\n    });\n  }\n}\n"]}